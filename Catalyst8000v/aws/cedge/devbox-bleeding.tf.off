data "aws_ami" "ubuntu-kinetic" {
  most_recent = true
  owners      = ["099720109477"]

  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-kinetic-22.10-amd64-server-*"]
  }

  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
}

resource "aws_instance" "devbox-cedge" {
  ami                         = "${data.aws_ami.ubuntu-kinetic.id}"
  instance_type               = "t2.small"
  vpc_security_group_ids      = ["${aws_security_group.transport.id}", "${aws_security_group.mosh.id}"]
  subnet_id                   = "${data.aws_subnet.subnet_transport.id}"
  private_ip                  = cidrhost(data.aws_subnet.subnet_transport.cidr_block, 17)
  associate_public_ip_address = true
  user_data                   = <<EOF
#cloud-config
ssh_pwauth: yes
hostname: devbox-${var.name}
users:
- name: cisco
  gecos: Cisco user
  shell: /bin/bash
  groups: [adm, users, crontab, kvm, tcpdump, _ssh, admin, netdev]
  # teccld-2000
  passwd: $6$rounds=4096$9aeGpcwNyf4$HZKW4yTmYDOPdnWNqNVLpalxnRlJOYiQJb/RK.8I15F9vUHLhfdhRSRJAO4nA7rYQH3whQe2RcET/jEEQBRMe.
  lock_passwd: False
  ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC3+do2TD2CcHpqiYkP2dRfSdWlxkeQtTjIK9YdtTEWq36MDvT893TiJww7R45kcMncikpgTj8FddKa+/Y3AzuyXHHeCSIzJNBApa/jSVgQ6JOO/liqqI2koglY1gasJqGHsdXFaoqs+67lc0QtlmuojKFpDjwWq2/UKC2Z4IFORk1pUVORw+voDdWhHGtfhoMIBv7CXABMyTdop1z2KkXxCc2m0MRmtypwNnF8NpxhTIsP3tF6d59cRcVmLBETp1KZYQ6dOdoFHxNRidOTRtD5FV10RzsHzS3Rx7ONUeQBNnsxRyRpLyozcrCpr+JyiOijJvKthcLQFnDj/20SiyQb
  sudo: ALL=(ALL) NOPASSWD:ALL
packages:
- net-tools
- kitty-terminfo
- mosh
- tmux
- docker.io
runcmd:
- chown -R cisco:cisco /home/cisco
- gpasswd -a cisco docker
- curl -Os https://downloads.thousandeyes.com/bbot/configure_docker.sh
- chmod +x configure_docker.sh
- ./configure_docker.sh
- su - cisco -c "/home/cisco/run-te-agent"
- ip address add 10.128.5.17/24 dev enX1
- ip link set dev enX1 up
- ip route add 10.128.0.0/16 via 10.128.5.11 dev enX1
- ip route add 22.0.0.0/8 via 10.128.5.11 dev enX1
write_files:
- path: /home/cisco/.bash_history
  permissions: '0600'
  content: |
    ip -br a
    ip r
- path: /home/cisco/.tmux.conf
  permissions: '0644'
  content: |
    set-option -g prefix C-a
    new-session
- path: /home/cisco/run-te-agent
  permissions: '0755'
  content: |
    docker pull thousandeyes/enterprise-agent > /dev/null 2>&1
    docker stop 'te-aws-multicloud' > /dev/null 2>&1
    docker rm 'te-aws-multicloud' > /dev/null 2>&1
    docker run \
      --hostname='te-aws-multicloud' \
      --memory=2g \
      --memory-swap=2g \
      --detach=true \
      --tty=true \
      --shm-size=512M \
      -e TEAGENT_ACCOUNT_TOKEN=${var.teagent_account_token} \
      -e TEAGENT_INET=4 \
      -v '/home/cisco/thousandeyes/te-aws-multicloud/te-agent':/var/lib/te-agent \
      -v '/home/cisco/thousandeyes/te-aws-multicloud/te-browserbot':/var/lib/te-browserbot \
      -v '/home/cisco/thousandeyes/te-aws-multicloud/log/':/var/log/agent \
      --cap-add=NET_ADMIN \
      --cap-add=SYS_ADMIN \
      --name 'te-aws-multicloud' \
      --restart=unless-stopped \
      --security-opt apparmor=docker_sandbox \
      --security-opt seccomp=/var/docker/configs/te-seccomp.json \
      --expose=49152/udp \
      --expose=49153/udp \
      --expose=49153/tcp \
      --publish=49152:49152/udp \
      --publish=49153:49153/udp \
      --publish=49153:49153/tcp \
      thousandeyes/enterprise-agent /sbin/my_init
EOF

  tags = {
    Name = "devbox-${var.name}"
  }
}

resource "aws_network_interface" "devbox-cedge" {
  subnet_id                   = "${data.aws_subnet.subnet_service.id}"
  security_groups             = ["${aws_security_group.service.id}"]
  private_ips                 = [cidrhost(data.aws_subnet.subnet_service.cidr_block, 17)]

  attachment {
    instance     = "${aws_instance.devbox-cedge.id}"
    device_index = 1
  }
}

resource "aws_security_group" "mosh" {
  name        = "allow_mosh"
  description = "Allow Mobile Shell inbound traffic"
  vpc_id      = data.aws_vpc.instance.id

  ingress {
    from_port   = 60000  # allow mosh
    to_port     = 61000
    protocol    = "udp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "allow_mosh"
  }
}

resource "aws_route53_record" "devbox-cedge" {
  count   = var.route53_zone == "" ? 0 : 1
  zone_id = data.aws_route53_zone.selected[0].zone_id
  name    = "devbox-${var.name}.${data.aws_route53_zone.selected[0].name}"
  type    = "A"
  ttl     = "300"
  records = [ "${aws_instance.devbox-cedge.public_ip}" ]
}

output "devbox_cedge_public_ip" {
  value = aws_instance.devbox-cedge.public_ip
}
